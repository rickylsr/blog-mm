---
title: '利用V2ray和闲置NAS，实现校园网免流'
date: 2020-09-19
permalink: /posts/2020/09/blog-post-1/
excerpt: "借助V2ray和家中NAS实现免流量"
tags:
  - 好东西
  - 技术
---


## 起因

随着流量资费逐渐降低，校园网1块钱1G的流量逐渐开始显得有些不合算。笔者所在的学校对ipv4网络收费，ipv6网络免费。现在，Windows、iOS、macOS更新、App Store 软件更新等动辄消耗大量流量，同时观看Netflix等流媒体也需要耗费大量流量。虽然可以使用教育网PT，但下载下来经常是整盘的大文件，电影动漫等如果想要用手机观看还需要拷贝，在日常使用场景中终究还是Bilibili和Netflix更方便一些。

在疫情期间，笔者在咸鱼上捡了一个星际蜗牛，卖家装上了DSM6.21系统（洗白），摆在西南的家中作为NAS使用。本以为可以在学校轻松访问NAS上Plex里的影音资源，但无奈家和学校相隔太远，ipv6直连群晖的访问速度极低，群晖官方提供的quickconnect又不能转发Plex，且quickconnect通过群晖ipv4服务器中转，也是要消耗校园网流量的，即便使用VideoStation也根本顶不住。

本文要尝试的是，让闲置在家的，有公网ipv6地址但没有公网ipv4地址的群晖NAS通过代理服务器的方式，发挥免流和科学上网的作用。

## 几个问题

### 有什么需要准备的

你需要有一台能够连接ipv4和ipv6的群晖NAS或者其他NAS、闲置电脑，并且将家中路由器的防火墙关闭（可以联系宽带师傅解决）
你需要正确配置校园网以使得学校内设备能接入ipv6网络
你需要配置vpn的基础知识

### 为什么要选择kcp

kcp协议以消耗更多流量为代价，能够降低延迟，增加连接速度。之前尝试过配置Socks5和SS协议或者使用ZeroTier，效果均不是特别理想。kcp现在在科学上网中逐渐被放弃，原因在于大量kcp流量跨境流动容易被识别和针对性封锁。但由于从教育网到家中NAS全程在国内，所以完全没问题。

### 速度如何

现在通过V2ray的kcp协议配置VPN，经笔者测试，能够达到20Mbps的速度（2m/s），已经足够观看大多数720P的视频。

### 一定注意

**kcp协议的vpn消耗流量通常为数倍甚至数十倍，因此切记当没有连接校园网时，及时将vpn关闭，尤其当你在NAS端添加了科学上网功能时。**


## 配置步骤
1. 确认自己拥有ipv6环境，并且ipv6不付费，ping一下NAS的ipv6地址，如果能够ping通，进入下一步
1. 在NAS上，用Docker部署V2ray，暂时不启动。安装方法可以参考[这里](https://wqdy.top/1165.html)
1. 在本地机器（校园网）上安装V2ray，建议Windows用户使用V2rayN（以下配置以V2rayN为例）
1. 在V2rayN界面左上角点击服务器——添加Vmess服务器，填写如下内容，并点击保存
```
地址：NAS的ipv6地址
端口：任意填写，最好填写20000-50000中的任意端口
额外ID：保持默认
用户ID：点击右边按钮生成
别名：写一个自己喜欢的名字吧~
**传输协议：kcp**
```
1. 在V2rayN界面上右键点击刚刚添加的服务器，选择导出所选配置为服务端配置。（本步骤和上一步骤实质上是以一个简单的方式获取V2ray的配置文件。当然，你可以自己编写json配置文件）
1. 用群晖自带的文本编辑器或者其他方式打开NAS上V2ray的config.json，删除全部内容，将上一步保存的json文件内容复制到群晖V2ray的config.json中
1. 将V2rayN参数设置中的路由设置-预定义规则改为全局
1. 连接此vpn，大功告成！


## 高级步骤

参照V2ray[官方教程](https://www.v2fly.org/config/overview.html)、[新白话文教程](https://guide.v2fly.org/)，通过修改NAS上V2ray的配置文件，添加outbounds和路由规则、DNS规则，实现科学上网、国内外分流、流媒体解锁、广告屏蔽等高级功能。
